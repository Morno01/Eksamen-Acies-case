@{
    ViewData["Title"] = "Indstillinger";
}

@if (!User.IsInRole("SuperUser"))
{
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Du har ikke adgang til denne side. Kun SuperUser kan ændre indstillinger.
    </div>
    return;
}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-white"><i class="fas fa-cog"></i> Optimering Indstillinger</h1>
        <p class="text-white">Konfigurer regler og parametre for palleoptimering algoritmen</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-sliders-h"></i> Algoritme Parametre</h4>
                <button class="btn btn-sm btn-outline-light" onclick="loadSettings()">
                    <i class="fas fa-sync"></i> Genindlæs
                </button>
            </div>
            <div class="card-body">
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Indlæser indstillinger...</p>
                </div>
                <form id="settingsForm" style="display: none;">
                    <input type="hidden" id="settingsId">

                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-layer-group"></i> Stabling</h5>

                            <div class="mb-3">
                                <label class="form-label">Maks antal lag *</label>
                                <input type="number" class="form-control" id="maksLag" min="1" max="10" required>
                                <small class="form-text text-muted">Hvor mange lag må der maksimalt være på en palle</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Tillad stabling op til maks højde (mm)</label>
                                <input type="number" class="form-control" id="tilladStablingOpTilMaksHoejdeInklPalle" placeholder="1500">
                                <small class="form-text text-muted">For at sikre at tømrerne kan fjerne elementer sikkert</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Tillad stabling op til maks element vægt (kg)</label>
                                <input type="number" step="0.1" class="form-control" id="tilladStablingOpTilMaksElementVaegt" placeholder="70.0">
                                <small class="form-text text-muted">Max elementvægt for stabling</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-sync-alt"></i> Rotation</h5>

                            <div class="mb-3">
                                <label class="form-label">Tillad vende op til maks vægt (kg) *</label>
                                <input type="number" step="0.1" class="form-control" id="tilladVendeOpTilMaksKg" required>
                                <small class="form-text text-muted">Hvor tunge må elementerne være før de ikke længere må vendes</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Højde/Bredde faktor *</label>
                                <input type="number" step="0.01" class="form-control" id="hoejdeBreddefaktor" required>
                                <small class="form-text text-muted">Mindste ratio mellem højde/bredde (f.eks. 0.3)</small>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="hoejdeBreddefaktorKunForEnkeltElementer">
                                <label class="form-check-label" for="hoejdeBreddefaktorKunForEnkeltElementer">
                                    Højde/Bredde faktor kun for enkelt elementer
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-sort"></i> Sortering</h5>

                            <div class="mb-3">
                                <label class="form-label">Sorteringsprioriteringer *</label>
                                <input type="text" class="form-control" id="sorteringsPrioritering" required>
                                <small class="form-text text-muted">Kommasepareret liste, f.eks: Type,Specialelement,Pallestorrelse,Elementstorrelse,Vaegt,Serie</small>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="placerLaengsteElementerYderst">
                                <label class="form-check-label" for="placerLaengsteElementerYderst">
                                    Placer længste elementer yderst
                                </label>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Maks balance værdi</label>
                                <input type="number" step="0.1" class="form-control" id="maksBalanceVaerdi" placeholder="100.0">
                                <small class="form-text text-muted">Hvis balancen overskrider dette tal, rykkes der rundt på rækkerne</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-ruler"></i> Øvrige</h5>

                            <div class="mb-3">
                                <label class="form-label">Tillæg montering af endeplade (mm)</label>
                                <input type="number" class="form-control" id="tillaegMonteringAfEndeplade" placeholder="20">
                                <small class="form-text text-muted">For at udregne den korrekte pallelængde</small>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="aktiv" checked>
                                <label class="form-check-label" for="aktiv">
                                    Aktiv profil
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> <strong>Bemærk:</strong> Disse indstillinger påvirker hvordan algoritmen optimerer paller. Vær forsigtig med at ændre værdier, da det kan påvirke kvaliteten af optimeringen.
                            </div>
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-save"></i> Gem Indstillinger
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE = window.location.origin;

        // Hent indstillinger
        async function loadSettings() {
            const loading = document.getElementById('loading');
            const form = document.getElementById('settingsForm');

            loading.style.display = 'block';
            form.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/settings`);
                const settings = await response.json();

                // Antag at vi henter den første aktive settings profil
                const setting = Array.isArray(settings) ? settings.find(s => s.aktiv) || settings[0] : settings;

                if (setting) {
                    document.getElementById('settingsId').value = setting.id;
                    document.getElementById('maksLag').value = setting.maksLag;
                    document.getElementById('tilladVendeOpTilMaksKg').value = setting.tilladVendeOpTilMaksKg;
                    document.getElementById('hoejdeBreddefaktor').value = setting.hoejdeBreddefaktor;
                    document.getElementById('hoejdeBreddefaktorKunForEnkeltElementer').checked = setting.hoejdeBreddefaktorKunForEnkeltElementer;
                    document.getElementById('tilladStablingOpTilMaksHoejdeInklPalle').value = setting.tilladStablingOpTilMaksHoejdeInklPalle || '';
                    document.getElementById('tilladStablingOpTilMaksElementVaegt').value = setting.tilladStablingOpTilMaksElementVaegt || '';
                    document.getElementById('tillaegMonteringAfEndeplade').value = setting.tillaegMonteringAfEndeplade;
                    document.getElementById('sorteringsPrioritering').value = setting.sorteringsPrioritering;
                    document.getElementById('placerLaengsteElementerYderst').checked = setting.placerLaengsteElementerYderst;
                    document.getElementById('maksBalanceVaerdi').value = setting.maksBalanceVaerdi || '';
                    document.getElementById('aktiv').checked = setting.aktiv;

                    form.style.display = 'block';
                } else {
                    alert('Ingen indstillinger fundet');
                }

            } catch (error) {
                alert('Fejl ved indlæsning: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Gem indstillinger
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const settings = {
                id: parseInt(document.getElementById('settingsId').value),
                navn: "Standard", // Kan udvides senere
                maksLag: parseInt(document.getElementById('maksLag').value),
                tilladVendeOpTilMaksKg: parseFloat(document.getElementById('tilladVendeOpTilMaksKg').value),
                hoejdeBreddefaktor: parseFloat(document.getElementById('hoejdeBreddefaktor').value),
                hoejdeBreddefaktorKunForEnkeltElementer: document.getElementById('hoejdeBreddefaktorKunForEnkeltElementer').checked,
                tilladStablingOpTilMaksHoejdeInklPalle: document.getElementById('tilladStablingOpTilMaksHoejdeInklPalle').value ? parseInt(document.getElementById('tilladStablingOpTilMaksHoejdeInklPalle').value) : null,
                tilladStablingOpTilMaksElementVaegt: document.getElementById('tilladStablingOpTilMaksElementVaegt').value ? parseFloat(document.getElementById('tilladStablingOpTilMaksElementVaegt').value) : null,
                tillaegMonteringAfEndeplade: parseInt(document.getElementById('tillaegMonteringAfEndeplade').value),
                aktiv: document.getElementById('aktiv').checked,
                sorteringsPrioritering: document.getElementById('sorteringsPrioritering').value,
                placerLaengsteElementerYderst: document.getElementById('placerLaengsteElementerYderst').checked,
                maksBalanceVaerdi: document.getElementById('maksBalanceVaerdi').value ? parseFloat(document.getElementById('maksBalanceVaerdi').value) : null
            };

            try {
                const response = await fetch(`${API_BASE}/api/settings/${settings.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Indstillinger gemt!');
                    loadSettings();
                } else {
                    alert('Fejl ved gem');
                }
            } catch (error) {
                alert('Fejl: ' + error.message);
            }
        });

        // Load indstillinger når siden er klar
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
}
